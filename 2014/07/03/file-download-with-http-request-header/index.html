<!DOCTYPE html>
<html id="html" class="html">
  <head lang="en_GB">
  <meta charset="utf-8" />
  <title data-react-helmet="true">File Download with HTTP Request Header - Brendan Graetz</title>
  <meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/><meta data-react-helmet="true" name="og:ttl" content="600"/><meta data-react-helmet="true" name="og:site_name" content="Brendan Graetz"/><meta data-react-helmet="true" name="og:description" content="The blog that Brendan writes"/><meta data-react-helmet="true" name="og:locale" content="en_GB"/><meta data-react-helmet="true" name="og:title" content="File Download with HTTP Request Header - Brendan Graetz"/><meta data-react-helmet="true" name="og:url" content="http://blog.bguiz.com/2014/07/03/file-download-with-http-request-header/"/><meta data-react-helmet="true" name="og:image" content="http://blog.bguiz.com/images/logo-400px.png"/><meta data-react-helmet="true" name="og:type" content="article"/>
  <link data-react-helmet="true" rel="canonical" content="http://blog.bguiz.com/2014/07/03/file-download-with-http-request-header/"/>
</head>
  <body>
    <div id="outlet" class="outlet">
      <div id="root-page" class="root-page"><noscript></noscript><div id="navbar" class="navbar__navbar___3unxB"><ul id="navbar-list" class="navbar__navbar-list___33l7N"><li class="navbar__navbar-item___bZsgu"><a class="fa fa-home" title="Brendan Graetz" href="/"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-files-o" title="Archives" href="/archives"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-television" title="Presentations" href="/presentations"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-book" title="Books" href="/books"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://twitter.com/bguiz" class="fa fa-twitter" title="@bguiz on Twitter"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://github.com/bguiz" class="fa fa-github" title="bguiz on github"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://stackoverflow.com/users/194982/bguiz" class="fa fa-stack-overflow" title="bguiz on stackoverflow"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://linkedin.com/in/brendangraetz/" class="fa fa-linkedin" title="Brendan Graetz on LinkedIn"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://reddit.com/u/bguiz" class="fa fa-reddit-alien" title="/u/bguiz on Reddit"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://plus.google.com/112370545733832378774?rel=author" class="fa fa-google-plus" title="@bguiz on Google+"></a></li></ul></div><div id="root-content" class="root-content"><div id="page-post" class="page page-post"><noscript></noscript><h1 id="page-title" class="page-title post-page__page-title___2KPKG">File Download with HTTP Request Header</h1><div id="page-body" class="page-body"><div class="post-page__post-date___3HkPG">2014/07/03</div><span class="markdown__markdown-render___9BIqe"><p>In a website which uses session-based authentication,
when a file needs to be downloaded, 
and that file should only accessible by the currently logged in user,
making that work client side in a web page is extremely easy.
That is because the session credentials are typically stored inside cookies,
and the browser automatically adds the cookies to every HTTP request&#8217;s headers
for that domain.</p>

<p>When you create an anchor tag, and set its URL to point to the route
that responds with the file to be downloaded;
and this anchor tag is clicked, that file will get downloaded,
as the authentication requirement for that route is satisfied by the cookie
that gets automatically added to the HTTP request header by the the browser.</p>

<p>However, it is not quite so simple if the website uses token-based authentication.
This is because browsers do not have any mechanism where it can be told to
add the token to each HTTP request&#8217;s headers across the board.</p>

<p>Let us say that you do the same thing as before:
create an anchor tag, and set its the URL to point to the route
that responds with the file to be downloaded.
The only difference is that this time, that route requires token in the header,
and there are no cookies involved.
Now when you click on this anchor tag,
the authentication requirement <em>is not met</em>,
and the file does not get downloaded.</p>

<p>My instinctive reaction to this was to find out a way to add
the token to the header of the HTTP <code>GET</code> request that gets
sent upon clicking the anchor link.
It turns out, however, that there is <em>no way</em> to do this;
there is simply no way to intercept that request and modify it before it gets sent.</p>

<p>So I asked <a href="http://stackoverflow.com/a/24523253/194982" title="How to set a header for a HTTP GET request, and trigger file download?" target="_blank">this question on Stackoverflow</a>.</p>

<p>The only way to add a header to any HTTP request is using AJAX -
by creating a <code>XMLHttpRequest</code>.
However, the catch is that you simply get the data in a JavaScript variable
in the callback function when the AJAX response arrives.
It does not trigger a file download, like clicking an anchor tag would.</p>

<blockquote class="twitter-tweet" data-cards="hidden" lang="en"><p>How to set a header for a HTTP GET request, and trigger file download? <a href="http://t.co/u7PnurXDjM" target="_blank">http://t.co/u7PnurXDjM</a></p>— Brendan Graetz (@bguiz) <a href="https://twitter.com/bguiz/statuses/483789449482862593" target="_blank">July 1, 2014</a></blockquote>

<p>How do we get around this? 
Turns out that there are a couple of rather creative solutions to the problem.</p>

<blockquote class="twitter-tweet" data-cards="hidden" lang="en"><p>Set a header on the HTTP request and have that trigger a file download with the response <a href="http://t.co/UIXr9CXXcO" target="_blank">http://t.co/UIXr9CXXcO</a> <a href="https://twitter.com/hashtag/javascript?src=hash" target="_blank">#javascript</a> <a href="https://twitter.com/hashtag/html5?src=hash" target="_blank">#html5</a> <a href="https://twitter.com/hashtag/solved?src=hash" target="_blank">#solved</a></p>— Brendan Graetz (@bguiz) <a href="https://twitter.com/bguiz/statuses/484204570071953408" target="_blank">July 2, 2014</a></blockquote>

<p>When the anchor tag is clicked, intercept the event, and initiate an AJAX request,
being sure to add the appropriate token in the request header:</p>

<pre><code>    var id = 123;
    var req = ic.ajax.raw({
        type: 'GET',
        url: '/api/dowloads/'+id,
        beforeSend: function (request) {
            request.setRequestHeader('token', 'token for '+id);
        },
        processData: false
    });
</code></pre>

<p>When the response is returned, we use a temporary anchor tag when handling it:</p>

<pre><code>    req.then(
        function resolve(result) {
            var str = result.response;

            var anchor = $('.vcard-hyperlink');

            /* transform the response into a file */

        }.bind(this),
        function reject(err) {
            console.log(err);
        }
    );
</code></pre>

<p>Depending on the size of the response,
and whether the browser is modern enough to support HTML5 File APIs,
we either use base64 encoding or temporary files.</p>

<p>Using HTML5 temporary files:</p>

<pre><code>            var maxSizeForBase64 = 1048576; //1024 * 1024
            var windowUrl = window.URL || window.webkitURL;
            if (str.length &gt; maxSizeForBase64 &amp;&amp; typeof windowUrl.createObjectURL === 'function') {
                var blob = new Blob([result.response], { type: 'text/bin' });
                var url = windowUrl.createObjectURL(blob);
                anchor.prop('href', url);
                anchor.prop('download', id+'.bin');
                anchor.get(0).click();
                windowUrl.revokeObjectURL(url);
            }
</code></pre>

<p>Using base64 encoding:</p>

<pre><code>            else {
                //use base64 encoding when less than set limit or file API is not available
                anchor.attr({
                    href: 'data:text/plain;base64,'+FormatUtils.utf8toBase64(result.response),
                    download: id+'.bin',
                });
                anchor.get(0).click();
            }
</code></pre>

<p>In both cases we set the anchor tag to a data URI or file URI,
and then trigger a click event on it.</p>

<p>The caveat for this however, is that both of these approaches are going to be
rather inefficient when downloading and processing large files.
More so for the base64 encoding method than the HTML5 File API method.</p>

<p>One way of solving this problem is to modify the server such that the route that
requires the token in the HTTP header does not respond with file contents,
but instead with the URL of a another route,
which <em>does not</em> require anything in the header at all, 
but expires very quickly.
It is this route which actually returns the file contents.</p>

<p>In my case however, I only needed to download rather small files
(mostly under 1KB), so this worked very well,
as I wanted to find if there was a way to solve this problem client-side.
With large files however, I would recommend considering using a server-side solution.</p>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></span></div><div id="page-footer" class="page-footer"><div class="share-buttons__share-buttons___3c-nq"><ul class="share-buttons__share-items___35ozf"><li class="share-buttons__share-item___10u_7"><a href="mailto:?subject=File Download with HTTP Request Header - Brendan Graetz&amp;amp;body=http://blog.bguiz.com/2014/07/03/file-download-with-http-request-header" class="share-buttons__share-button-email___3ktqW share-buttons__share-button___36_MO"><span class="fa fa-envelope"></span><div class="share-count"> </div></a></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--facebook share-buttons__share-button-facebook___uSKF_ share-buttons__share-button___36_MO"><span class="fa fa-facebook"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--twitter share-buttons__share-button-twitter___3vZWS share-buttons__share-button___36_MO"><span class="fa fa-twitter"></span><div class="share-count"> </div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--googlePlus share-buttons__share-button-google-plus___1OUuW share-buttons__share-button___36_MO"><span class="fa fa-google-plus"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--linkedin share-buttons__share-button-linkedin___2EwnF share-buttons__share-button___36_MO"><span class="fa fa-linkedin"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li></ul></div><div><span>Tagged in:</span><ul class="post-tags__tags-list___3m4XD"><li class="post-tags__tags-item___3xlEk"><a href="/tags/javascript">javascript</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/html5">html5</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/http">http</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/blog">blog</a></li></ul></div><div><a href="https://github.com/bguiz/blog.bguiz.com/blob/develop/src/documents/tumblrposts/2014-07-03-file-download-with-http-request-header.html" target="_blank">Edit this content</a></div><div><div title="File Download with HTTP Request Header"><div id="disqus_thread"></div><noscript><span>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></span></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footprofile" class="foot-profile__footprofile___23hoj"><div class="foot-profile__footprofile-logo___3JA-e"><img src="/images/logo-100px.png" alt="Brendan Graetz"/></div><div class="foot-profile__footprofile-links___3U9KR"><ul class="foot-profile__footer-links___2SYBF"><li class="foot-profile__footer-item___22yBd"><a title="Brendan Graetz" href="/"><span class="fa fa-home foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Brendan Graetz</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Archives" href="/archives"><span class="fa fa-files-o foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Archives</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Presentations" href="/presentations"><span class="fa fa-television foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Presentations</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Books" href="/books"><span class="fa fa-book foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Books</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://twitter.com/bguiz" title="@bguiz on Twitter"><span class="fa fa-twitter foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">@bguiz</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://github.com/bguiz" title="bguiz on github"><span class="fa fa-github foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Github</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://stackoverflow.com/users/194982/bguiz" title="bguiz on stackoverflow"><span class="fa fa-stack-overflow foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Stackoverflow</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://linkedin.com/in/brendangraetz/" title="Brendan Graetz on LinkedIn"><span class="fa fa-linkedin foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">LinkedIn</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://reddit.com/u/bguiz" title="/u/bguiz on Reddit"><span class="fa fa-reddit-alien foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Reddit</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://plus.google.com/112370545733832378774?rel=author" title="@bguiz on Google+"><span class="fa fa-google-plus foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">+bguiz.com</span></a></li></ul></div><div class="foot-profile__clear___1vNYP"></div></div><div id="footbar" class="footbar__footbar___2dhrz"><p class="footbar__footbar-text___Rc4dT">Copyright © 2008-present Brendan Graetz</p></div></div>
    </div>
    
<link rel="stylesheet" type="text/css" href="/app.css">
<link rel="stylesheet" type="text/css" href="/3rd-party/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/3rd-party/highlight-js/css/dracula.css">
<script type="text/javascript" src="/bundle.js"></script>
  </body>
</html>