<!DOCTYPE html>
<html id="html" class="html">
  <head lang="en_GB">
  <meta charset="utf-8" />
  <title data-react-helmet="true">Mocking Chained APIs in Jest - Brendan Graetz</title>
  <meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/><meta data-react-helmet="true" name="og:ttl" content="600"/><meta data-react-helmet="true" name="og:site_name" content="Brendan Graetz"/><meta data-react-helmet="true" name="og:description" content="The blog that Brendan writes"/><meta data-react-helmet="true" name="og:locale" content="en_GB"/><meta data-react-helmet="true" name="og:title" content="Mocking Chained APIs in Jest - Brendan Graetz"/><meta data-react-helmet="true" name="og:url" content="http://blog.bguiz.com/2017/mocking-chained-apis-jest/"/><meta data-react-helmet="true" name="og:image" content="http://blog.bguiz.com/images/posts/mocking-chained-apis-jest.jpeg"/><meta data-react-helmet="true" name="og:type" content="article"/>
  <link data-react-helmet="true" rel="canonical" content="http://blog.bguiz.com/2017/mocking-chained-apis-jest/"/>
</head>
  <body>
    <div id="outlet" class="outlet">
      <div id="root-page" class="root-page"><noscript></noscript><div id="navbar" class="navbar__navbar___3unxB"><ul id="navbar-list" class="navbar__navbar-list___33l7N"><li class="navbar__navbar-item___bZsgu"><a class="fa fa-home" title="Brendan Graetz" href="/"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-files-o" title="Archives" href="/archives"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-television" title="Presentations" href="/presentations"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-book" title="Books" href="/books"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://twitter.com/bguiz" class="fa fa-twitter" title="@bguiz on Twitter"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://github.com/bguiz" class="fa fa-github" title="bguiz on github"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://stackoverflow.com/users/194982/bguiz" class="fa fa-stack-overflow" title="bguiz on stackoverflow"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://linkedin.com/in/brendangraetz/" class="fa fa-linkedin" title="Brendan Graetz on LinkedIn"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://reddit.com/u/bguiz" class="fa fa-reddit-alien" title="/u/bguiz on Reddit"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://plus.google.com/112370545733832378774?rel=author" class="fa fa-google-plus" title="@bguiz on Google+"></a></li></ul></div><div id="root-content" class="root-content"><div id="page-post" class="page page-post"><noscript></noscript><h1 id="page-title" class="page-title post-page__page-title___2KPKG">Mocking Chained APIs in Jest</h1><div id="page-body" class="page-body"><div class="post-page__post-date___3HkPG">2017/03/31</div><img src="/images/posts/mocking-chained-apis-jest.jpeg" alt="Mocking Chained APIs in Jest" id="post-headImage" class="post-page__post-headImage___1lBxm"/><span class="markdown__markdown-render___9BIqe"><p><code>jest</code> is a test runner that has all batteries included.
Previously I have been using <code>mocha</code>, which is only a test runner.
<code>mocha</code>, on the other hand, has assertions, mocking,
and all the other bells and whistles, all baked in.
With <code>mocha</code>, you would need to <code>require()</code> these in,
from other modules - my go to ones were <code>chai</code> and <code>sinon</code>.
Further to this, <code>jest</code> adds snapshot testing,
which is something I have not previously done in <code>mocha</code> -
that is perhaps something for a another article.</p>
<p>Suffice to say that <code>jest</code> testing covers a huge surface area.
Here we will focus on just one aspect of it - mocking.
In particular, mocking chained APIs.</p>
<h2 id="chained-api">Chained API</h2>
<p>A large part of the code that I am presently writing,
and therefore also testing,
happens to be <code>express</code> middleware/ end points.
For this asserting the API response is crucial,
and a typical usage of it looks like this:</p>
<pre class="hljs js lang-js">res.status(<span class="hljs-number">200</span>).json({ <span class="hljs-attr">foo</span>: <span class="hljs-string">'bar'</span> });</pre><p>A chained API is one which returns the original object,
rather than the result of the operation,
from each function call.
While this might be counter intuitive
(why not just return the result?)
it does result in a rather easy way to invoke multiple
function on the same, possibly mutable, object.
From an implementor’s point of view,
it is a very quick way to sort of create a
<a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a>.</p>
<h2 id="split-mock-definition-from-mock-implementation">Split mock definition from mock implementation</h2>
<p>An object which exposes a chained API is
great for both its implementor,
and its consumer…
but not so great for someone who wishes to mock it for testing purposes.</p>
<p>In <code>jest</code>,
<a href="https://facebook.github.io/jest/docs/jest-object.html#jestfnimplementation"><code>jest.fn(implementation)</code></a>
allows one to create a mock function with an custom implementation.
Mocking a chained API using this alone is an impossible venture.
Dig a little deeper into the docs, however,
and you will find that you can do
<a href="https://facebook.github.io/jest/docs/mock-function-api.html#mockfnmockimplementationfn"><code>jest.fn().mockImplementation(implementation)</code></a>.
You might notice that that in itself adheres to my prior definition of a chained API,
as <code>.fn()</code> returns a mock function,
and it is missing any implementation,
so it simply defaults to a no-op function.
Subsequently we call <code>.mockImplementation(ourOwnImpl)</code>.
This time it contains our own implementation,
which supersedes the previous no-op implementation,
since <code>jest</code> mock functions are mutable.
In fact, if we were to subsequently do so again,
<code>.mockImplementation(ourSecondImpl)</code>,
our second implementation would supersede our previous one.</p>
<p>Now, in a neat-o little trick,
we are going to use a chained API to test another chained API:</p>
<pre class="hljs js lang-js"><span class="hljs-keyword">let</span> res;
<span class="hljs-keyword">let</span> resSet;
<span class="hljs-keyword">let</span> resStatus;
<span class="hljs-keyword">let</span> resJson;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setUpExpressMocks</span> (<span class="hljs-params"></span>) </span>{
        resJson = jest.fn();
        resStatus = jest.fn();
        resSet = jest.fn();
        res = {
                <span class="hljs-attr">set</span>: resSet,
                <span class="hljs-attr">status</span>: resStatus,
                <span class="hljs-attr">json</span>: resJson,
        };
        resJson.mockImplementation(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> res);
        resStatus.mockImplementation(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> res);
        resSet.mockImplementation(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> res);
}</pre><p>In order to do so however,
without incurring a lot of test code bloat,
we will not use <code>jest</code>‘s chained API as a chained API,
but rather break it up,
and store the intermediate result in a variable.
In between part one and part two,
we create the return object,
that is to be returned by all mock the mocked functions,
in order to have them all be part of a chained <em>and</em> mocked API.</p>
<h2 id="in-a-jest-testing">In a <code>jest</code> Testing</h2>
<pre class="hljs js lang-js">describe(<span class="hljs-string">'[test an express res]'</span> =&gt; () {

    <span class="hljs-comment">// define setUpExpressMocks and the variables it uses over here</span>

    beforeAll(setUpExpressMocks);

    it(<span class="hljs-string">'should test res with default mocks'</span>, () =&gt; {
        <span class="hljs-comment">// Do assertions right away</span>
        <span class="hljs-comment">// expect() ...</span>
    });

    it(<span class="hljs-string">'should test res with .json() override'</span>, (done) =&gt; {
        resJson.mockImplementation(<span class="hljs-function">(<span class="hljs-params">json</span>) =&gt;</span> {
            <span class="hljs-comment">// Do assertions within overridden mock implementation</span>
            <span class="hljs-comment">// expect() ...</span>
            <span class="hljs-keyword">return</span> res; <span class="hljs-comment">// don't break the API chain</span>
        });
    });
});</pre><h2 id="well-designed-apis">Well designed APIs</h2>
<p>Kudos to the <code>jest</code> team for designing the APIs in this manner.
I do not know if it was by accident, or by intent,
but being able to split the creation of a mock function
from setting its implementation
was a major win when it came to mocking chained APIs.</p>
</span></div><div id="page-footer" class="page-footer"><div class="share-buttons__share-buttons___3c-nq"><ul class="share-buttons__share-items___35ozf"><li class="share-buttons__share-item___10u_7"><a href="mailto:?subject=Mocking Chained APIs in Jest - Brendan Graetz&amp;amp;body=http://blog.bguiz.com/2017/mocking-chained-apis-jest" class="share-buttons__share-button-email___3ktqW share-buttons__share-button___36_MO"><span class="fa fa-envelope"></span><div class="share-count"> </div></a></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--facebook share-buttons__share-button-facebook___uSKF_ share-buttons__share-button___36_MO"><span class="fa fa-facebook"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--twitter share-buttons__share-button-twitter___3vZWS share-buttons__share-button___36_MO"><span class="fa fa-twitter"></span><div class="share-count"> </div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--googlePlus share-buttons__share-button-google-plus___1OUuW share-buttons__share-button___36_MO"><span class="fa fa-google-plus"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--linkedin share-buttons__share-button-linkedin___2EwnF share-buttons__share-button___36_MO"><span class="fa fa-linkedin"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li></ul></div><div><span>Tagged in:</span><ul class="post-tags__tags-list___3m4XD"><li class="post-tags__tags-item___3xlEk"><a href="/tags/javascript">javascript</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/jest">jest</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/test">test</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/mock">mock</a></li></ul></div><div><a href="https://github.com/bguiz/blog.bguiz.com/blob/develop/src/documents/reactpubposts/2017-03-mocking-chained-apis-jest.md" target="_blank">Edit this content</a></div><div><div title="Mocking Chained APIs in Jest"><div id="disqus_thread"></div><noscript><span>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></span></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footprofile" class="foot-profile__footprofile___23hoj"><div class="foot-profile__footprofile-logo___3JA-e"><img src="/images/logo-100px.png" alt="Brendan Graetz"/></div><div class="foot-profile__footprofile-links___3U9KR"><ul class="foot-profile__footer-links___2SYBF"><li class="foot-profile__footer-item___22yBd"><a title="Brendan Graetz" href="/"><span class="fa fa-home foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Brendan Graetz</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Archives" href="/archives"><span class="fa fa-files-o foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Archives</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Presentations" href="/presentations"><span class="fa fa-television foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Presentations</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Books" href="/books"><span class="fa fa-book foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Books</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://twitter.com/bguiz" title="@bguiz on Twitter"><span class="fa fa-twitter foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">@bguiz</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://github.com/bguiz" title="bguiz on github"><span class="fa fa-github foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Github</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://stackoverflow.com/users/194982/bguiz" title="bguiz on stackoverflow"><span class="fa fa-stack-overflow foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Stackoverflow</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://linkedin.com/in/brendangraetz/" title="Brendan Graetz on LinkedIn"><span class="fa fa-linkedin foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">LinkedIn</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://reddit.com/u/bguiz" title="/u/bguiz on Reddit"><span class="fa fa-reddit-alien foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Reddit</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://plus.google.com/112370545733832378774?rel=author" title="@bguiz on Google+"><span class="fa fa-google-plus foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">+bguiz.com</span></a></li></ul></div><div class="foot-profile__clear___1vNYP"></div></div><div id="footbar" class="footbar__footbar___2dhrz"><p class="footbar__footbar-text___Rc4dT">Copyright © 2008-present Brendan Graetz</p></div></div>
    </div>
    
<link rel="stylesheet" type="text/css" href="/app.css">
<link rel="stylesheet" type="text/css" href="/3rd-party/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/3rd-party/highlight-js/css/dracula.css">
<script type="text/javascript" src="/bundle.js"></script>
  </body>
</html>