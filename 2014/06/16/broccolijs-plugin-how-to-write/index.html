<!DOCTYPE html>
<html id="html" class="html">
  <head lang="en_GB">
  <meta charset="utf-8" />
  <title data-react-helmet="true">How to Write a BroccoliJs Plugin - Brendan Graetz</title>
  <meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/><meta data-react-helmet="true" name="og:ttl" content="600"/><meta data-react-helmet="true" name="og:site_name" content="Brendan Graetz"/><meta data-react-helmet="true" name="og:description" content="The blog that Brendan writes"/><meta data-react-helmet="true" name="og:locale" content="en_GB"/><meta data-react-helmet="true" name="og:title" content="How to Write a BroccoliJs Plugin - Brendan Graetz"/><meta data-react-helmet="true" name="og:url" content="http://blog.bguiz.com/2014/06/16/broccolijs-plugin-how-to-write/"/><meta data-react-helmet="true" name="og:image" content="http://blog.bguiz.com/images/logo-400px.png"/><meta data-react-helmet="true" name="og:type" content="article"/>
  <link data-react-helmet="true" rel="canonical" content="http://blog.bguiz.com/2014/06/16/broccolijs-plugin-how-to-write/"/>
</head>
  <body>
    <div id="outlet" class="outlet">
      <div id="root-page" class="root-page"><noscript></noscript><div id="navbar" class="navbar__navbar___3unxB"><ul id="navbar-list" class="navbar__navbar-list___33l7N"><li class="navbar__navbar-item___bZsgu"><a class="fa fa-home" title="Brendan Graetz" href="/"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-files-o" title="Archives" href="/archives"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-television" title="Presentations" href="/presentations"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-book" title="Books" href="/books"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://twitter.com/bguiz" class="fa fa-twitter" title="@bguiz on Twitter"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://github.com/bguiz" class="fa fa-github" title="bguiz on github"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://stackoverflow.com/users/194982/bguiz" class="fa fa-stack-overflow" title="bguiz on stackoverflow"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://linkedin.com/in/brendangraetz/" class="fa fa-linkedin" title="Brendan Graetz on LinkedIn"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://reddit.com/u/bguiz" class="fa fa-reddit-alien" title="/u/bguiz on Reddit"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://plus.google.com/112370545733832378774?rel=author" class="fa fa-google-plus" title="@bguiz on Google+"></a></li></ul></div><div id="root-content" class="root-content"><div id="page-post" class="page page-post"><noscript></noscript><h1 id="page-title" class="page-title post-page__page-title___2KPKG">How to Write a BroccoliJs Plugin</h1><div id="page-body" class="page-body"><div class="post-page__post-date___3HkPG">2014/06/16</div><span class="markdown__markdown-render___9BIqe"><p>Recently, I released <a href="https://github.com/bguiz/broccoli-sprite" target="_blank">broccoli-sprite</a>.
I was just a week into using BroccoliJs for the first time,
and writing a plugin for a build system that I had barely used
was understandably tricky.</p>

<p>While writing it, I googled quite a bit for how to write a BroccoliJs plugin,
but there really has not been much written about it.
I would like to make it easier for others doing the same thing,
so here is a quick overview of the process of creating a BroccoliJs plugin.</p>

<h2>Basics</h2>

<p>What is <a href="https://github.com/broccolijs/broccoli" target="_blank">BroccoliJs</a>?
Think [GruntJs], but different.
Different how?
Well in a number of ways. Its creator, Jo Liss,
[explains its philosophy in her post on its release].</p>

<p>tl;dr= Plugins can chain their output to one another,
and the built-in watch only rebuilds what has changed rather than the whole lot.</p>

<p>There is one more thing to it:
If you are building an app using <a href="https://github.com/stefanpenner/ember-cli" target="_blank">ember-cli</a>,
you will <em>need</em> to use BroccoliJs.</p>

<h2>Sold! Now Time to Write a BroccoliJs Plugin</h2>

<p>The first thing to take a look at is the
<a href="https://github.com/broccolijs/broccoli#plugin-api-specification" target="_blank">plugin API specification</a>.
Looks very straight forward:
There are just two things that you need to implement:
<code>tree.read()</code>and <code>tree.cleanup()</code>.
The former, however, does not really do much that is useful, on its own at least.</p>

<h2>Getting started</h2>

<p>All BroccoliJs plugins are NodeJs modules that should be installed
inside a project</p>

<pre><code>cd my-project/
npm install --save-dev broccoli-my-plugin
</code></pre>

<p>… and thus the first step is to create an <code>npm</code> package:</p>

<pre><code>mkdir broccoli-my-plugin #replace `my-plugin` with the name you would like
cd broccoli-my-plugin/
#if you plan to use version control (which is a good idea), do it now, e.g.
#git init &amp;&amp; git flow init
npm init #this creates `package.json`
#be sure to specifiy one of the keywords as `broccoli-plugin`
</code></pre>

<p>Now you will need to edit <code>index.js</code>, which exports your plugin:</p>

<pre><code>var BroccoliMyPlugin = function BroccoliMyPlugin() {};
modules.exports = BroccoliMyPlugin;
</code></pre>

<h3>Extending an Existing BroccoliJs Plugin</h3>

<p>BroccoliJs has several plugins, that are designed to be extended.
The one that we will look at here is
<a href="https://github.com/broccolijs/broccoli-writer" target="_blank">broccoli-writer</a>.</p>

<p>Install it:</p>

<pre><code>npm install broccoli-writer
</code></pre>

<p>Edit <code>index.js</code>:</p>

<pre><code>var brocWriter = require('broccoli-writer');

var BroccoliMyPlugin = function BroccoliMyPlugin() {
  if (!(this instanceof BroccoliMyPlugin)) {
    return new BroccoliMyPlugin();
  }
};
BroccoliMyPlugin.prototype = Object.create(brocWriter.prototype);
BroccoliMyPlugin.prototype.constructor = BroccoliMyPlugin;
BroccoliMyPlugin.prototype.description = 'my-plugin';
modules.exports = BroccoliMyPlugin;
</code></pre>

<p>Here we have simply extended the function exported by broccoli-writer
using prototypical inheritance.
At the moment it does not do anything at all,
and we will add that next.</p>

<h3>Adding functionality</h3>

<p>Firstly, we should make the plugin able to accept some input parameters.
All BroccoliJs plugins <em>must</em> accept an input tree as its first argument.
Any subsequent parameters are completely up to you as the plugin developer.
A common pattern, however, seems to be to accept just one parameter,
and <code>options</code> hash, which is what we will do here.</p>

<pre><code>var brocWriter = require('broccoli-writer');

var BroccoliMyPlugin = function BroccoliMyPlugin(inTree, options) {
  if (!(this instanceof BroccoliMyPlugin)) {
    return new BroccoliMyPlugin(inTree, options);
  }
  this.inTree = inTree;
  this.options = options || {};
};
BroccoliMyPlugin.prototype = Object.create(brocWriter.prototype);
BroccoliMyPlugin.prototype.constructor = BroccoliMyPlugin;
BroccoliMyPlugin.prototype.description = 'my-plugin';
modules.exports = BroccoliMyPlugin;
</code></pre>

<p>We add the <code>inTree</code> and <code>options</code> parameters to the constructor function,
and then save them in the instance.
If you wish to specify default options,
or other instance variables,
this is where you would parse and set them.</p>

<p>Next we can implement the main functionality,
the part where we specify the thing that this plugin does.
Since this plugins extends the <code>broccoli-writer</code> plugin,
we do this by specifying a <code>write</code>function:</p>

<pre><code>BroccoliMyPlugin.prototype.write = function(readTree, destDir) {
  var self = this;
  return readTree(this.inTree).then(function (srcDir) {
    /* use srcDir and information from self.options to figure out which files to read from */
    /* use destDir and information from self.options to figure outwhich files to write to */
    /* synchronously read input files, do some processing, and write output files */
  });
};
</code></pre>

<p><code>readTree</code> is passed in as the first variable to the <code>write function,
and this is a function that returns a promise that you should return.
Call</code>then()`on the promise, and do the processing in the callback function.
Here you do whatever it is the plugin needs to do;
but you have to do it synchronously - no callbacks allowed.</p>

<h3>Asynchronous Plugins</h3>

<p>Most of the time however, we want to do things asynchronously -
after all, that is the NodeJs way!
See Mixu&#8217;s article on <a href="http://book.mixu.net/node/ch7.html" target="_blank">control flow in NodeJs</a>
for an excellent introduction to asynchronous code in NodeJs.
We need to get a little more advance than this however,
and use promises instead of callbacks.
Not to worry though, promises are actually much more straight forward to use
than callbacks!
In fact, we have already used the one returned by the <code>readTree</code> function previously.</p>

<p>We shall use promises implemented in the RSVP library,
as that appears to be the most popular choice amongst Broccoli plugins;
although you are free to use any other promise library.</p>

<p>Install RSVP:</p>

<pre><code>npm install --save rsvp
</code></pre>

<p>Include RSVP:</p>

<pre><code>var rsvp= require('rsvp');
</code></pre>

<p>Modify the <code>readTree</code> callback to create a promise an return it.</p>

<pre><code>return readTree(this.inTree).then(function (srcDir) {
  /* use srcDir and information from self.options to figure out which files to read from */
  /* use destDir and information from self.options to figure outwhich files to write to */
  var promise = new rsvp.Promise(function(resolvePromise, rejectPromise) {
    /* asynchronously read input files, do some processing, and write output files,
       for example, here we have `someAsyncFunc` that does this` */
    someAsyncFunc(function(err, asyncData) {
      if (err) {
        rejectPromise(err);
      }
      else {
        resolvePromise(asyncData);
      }
    });
  });
  return promise;
});
</code></pre>

<p>Here, since we return a promise, BroccoliJs knows to wait until it is
either resolved or rejected.
For the more astute, you will notice that here we actually have
a promise within a promise, as <code>readTree</code> itself returns a promise.
We could possibly refactor this to chain the promises instead of nesting them,
but I shall leave that as an exercise for the reader!</p>

<h2>Fin</h2>

<p>Now we have a functional BroccoliJs plugin, and it is ready to be published:</p>

<pre><code>npm publish
</code></pre>

<p>… and now anyone can <code>npm install</code> it!</p>

<h2>Going further</h2>

<p>Besides <a href="https://github.com/broccolijs/broccoli-writer" target="_blank">broccoli-writer</a>,
there is also <a href="https://github.com/broccolijs/broccoli-filter" target="_blank">broccoli-filter</a>,
and <a href="https://github.com/rjackson/broccoli-caching-writer" target="_blank">broccoli-caching-writer</a>, 
which I have not covered here.</p>

<p>Depending on what your plugin does, you might want to extend these instead.
One great way to learn more about writing BroccoliJs plugins is to
<a href="https://www.npmjs.org/search?q=broccoli-plugin" target="_blank">search for existing ones</a>,
and examine the source code for each one.
Most of them are fairly simple, only containing a single <code>index.js</code> file,
which means that you will likely find what you are looking for rather quickly.
In fact, that is precisely what I did to get up to speed,
when writing <a href="https://github.com/bguiz/broccoli-sprite" target="_blank">brocoli-sprite</a>.</p>

<p><a href="https://github.com/bguiz/broccoli-sprite" target="_blank"><img src="https://nodei.co/npm/broccoli-sprite.png?compact=true" alt="NPM"/></a></p>

<p>Good luck with yours!</p></span></div><div id="page-footer" class="page-footer"><div class="share-buttons__share-buttons___3c-nq"><ul class="share-buttons__share-items___35ozf"><li class="share-buttons__share-item___10u_7"><a href="mailto:?subject=How to Write a BroccoliJs Plugin - Brendan Graetz&amp;amp;body=http://blog.bguiz.com/2014/06/16/broccolijs-plugin-how-to-write" class="share-buttons__share-button-email___3ktqW share-buttons__share-button___36_MO"><span class="fa fa-envelope"></span><div class="share-count"> </div></a></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--facebook share-buttons__share-button-facebook___uSKF_ share-buttons__share-button___36_MO"><span class="fa fa-facebook"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--twitter share-buttons__share-button-twitter___3vZWS share-buttons__share-button___36_MO"><span class="fa fa-twitter"></span><div class="share-count"> </div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--googlePlus share-buttons__share-button-google-plus___1OUuW share-buttons__share-button___36_MO"><span class="fa fa-google-plus"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--linkedin share-buttons__share-button-linkedin___2EwnF share-buttons__share-button___36_MO"><span class="fa fa-linkedin"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li></ul></div><div><span>Tagged in:</span><ul class="post-tags__tags-list___3m4XD"><li class="post-tags__tags-item___3xlEk"><a href="/tags/broccolijs">broccolijs</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/nodejs">nodejs</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/javascript">javascript</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/tutorial">tutorial</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/blog">blog</a></li></ul></div><div><a href="https://github.com/bguiz/blog.bguiz.com/blob/develop/src/documents/tumblrposts/2014-06-16-broccolijs-plugin-how-to-write.html" target="_blank">Edit this content</a></div><div><div title="How to Write a BroccoliJs Plugin"><div id="disqus_thread"></div><noscript><span>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></span></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footprofile" class="foot-profile__footprofile___23hoj"><div class="foot-profile__footprofile-logo___3JA-e"><img src="/images/logo-100px.png" alt="Brendan Graetz"/></div><div class="foot-profile__footprofile-links___3U9KR"><ul class="foot-profile__footer-links___2SYBF"><li class="foot-profile__footer-item___22yBd"><a title="Brendan Graetz" href="/"><span class="fa fa-home foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Brendan Graetz</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Archives" href="/archives"><span class="fa fa-files-o foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Archives</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Presentations" href="/presentations"><span class="fa fa-television foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Presentations</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Books" href="/books"><span class="fa fa-book foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Books</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://twitter.com/bguiz" title="@bguiz on Twitter"><span class="fa fa-twitter foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">@bguiz</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://github.com/bguiz" title="bguiz on github"><span class="fa fa-github foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Github</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://stackoverflow.com/users/194982/bguiz" title="bguiz on stackoverflow"><span class="fa fa-stack-overflow foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Stackoverflow</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://linkedin.com/in/brendangraetz/" title="Brendan Graetz on LinkedIn"><span class="fa fa-linkedin foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">LinkedIn</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://reddit.com/u/bguiz" title="/u/bguiz on Reddit"><span class="fa fa-reddit-alien foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Reddit</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://plus.google.com/112370545733832378774?rel=author" title="@bguiz on Google+"><span class="fa fa-google-plus foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">+bguiz.com</span></a></li></ul></div><div class="foot-profile__clear___1vNYP"></div></div><div id="footbar" class="footbar__footbar___2dhrz"><p class="footbar__footbar-text___Rc4dT">Copyright © 2008-present Brendan Graetz</p></div></div>
    </div>
    
<link rel="stylesheet" type="text/css" href="/app.css">
<link rel="stylesheet" type="text/css" href="/3rd-party/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/3rd-party/highlight-js/css/dracula.css">
<script type="text/javascript" src="/bundle.js"></script>
  </body>
</html>