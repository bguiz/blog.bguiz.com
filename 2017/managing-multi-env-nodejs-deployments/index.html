<!DOCTYPE html>
<html id="html" class="html">
  <head lang="en_GB">
  <meta charset="utf-8" />
  <title data-react-helmet="true">Managing NodeJs Deployments in Multiple Environments - Brendan Graetz</title>
  <meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/><meta data-react-helmet="true" name="og:ttl" content="600"/><meta data-react-helmet="true" name="og:site_name" content="Brendan Graetz"/><meta data-react-helmet="true" name="og:description" content="The blog that Brendan writes"/><meta data-react-helmet="true" name="og:locale" content="en_GB"/><meta data-react-helmet="true" name="og:title" content="Managing NodeJs Deployments in Multiple Environments - Brendan Graetz"/><meta data-react-helmet="true" name="og:url" content="http://blog.bguiz.com/2017/managing-multi-env-nodejs-deployments/"/><meta data-react-helmet="true" name="og:image" content="http://blog.bguiz.com/images/posts/erun.png"/><meta data-react-helmet="true" name="og:type" content="article"/>
  <link data-react-helmet="true" rel="canonical" content="http://blog.bguiz.com/2017/managing-multi-env-nodejs-deployments/"/>
</head>
  <body>
    <div id="outlet" class="outlet">
      <div id="root-page" class="root-page"><noscript></noscript><div id="navbar" class="navbar__navbar___3unxB"><ul id="navbar-list" class="navbar__navbar-list___33l7N"><li class="navbar__navbar-item___bZsgu"><a class="fa fa-home" title="Brendan Graetz" href="/"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-files-o" title="Archives" href="/archives"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-television" title="Presentations" href="/presentations"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-book" title="Books" href="/books"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://twitter.com/bguiz" class="fa fa-twitter" title="@bguiz on Twitter"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://github.com/bguiz" class="fa fa-github" title="bguiz on github"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://stackoverflow.com/users/194982/bguiz" class="fa fa-stack-overflow" title="bguiz on stackoverflow"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://linkedin.com/in/brendangraetz/" class="fa fa-linkedin" title="Brendan Graetz on LinkedIn"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://reddit.com/u/bguiz" class="fa fa-reddit-alien" title="/u/bguiz on Reddit"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://plus.google.com/112370545733832378774?rel=author" class="fa fa-google-plus" title="@bguiz on Google+"></a></li></ul></div><div id="root-content" class="root-content"><div id="page-post" class="page page-post"><noscript></noscript><h1 id="page-title" class="page-title post-page__page-title___2KPKG">Managing NodeJs Deployments in Multiple Environments</h1><div id="page-body" class="page-body"><div class="post-page__post-date___3HkPG">2017/01/29</div><img src="/images/posts/erun.png" alt="Managing NodeJs Deployments in Multiple Environments" id="post-headImage" class="post-page__post-headImage___1lBxm"/><span class="markdown__markdown-render___9BIqe"><p>After managing an extremely large scale NodeJs deployment last year.
I learnt a great deal about production deployments with a focus on scalability.
The retrospective summary of these learning points are in a presentation given last year:
<a href="http://blog.bguiz.com/presentations/nodejs-servers-at-scale/">Top 7 Things Learnt Deploying NodeJs Servers at Scale</a>.</p>
<p>Production deployments are about a whole lot more than <em>scalability</em> though,
and we’ll examine another aspect of them here:
Managing multiple deployment environments.</p>
<h2 id="what-are-deployment-environments-anyway-">What are deployment environments anyway?</h2>
<p>To get to a <em>production deployment</em>,
you will need intermediate deployments,
and to get to those <em>intermediate deployments</em>,
you will need a <em>local deployment</em>.</p>
<p>Deployment environments are different computers where
a project can run.
Facilitating that, however, is <em>tricky business</em>!</p>
<h3 id="local-deployment-environment">Local deployment environment</h3>
<p>A local deployment is the one that a developer runs on their own computer,
while writing code, debugging it, et cetera.
A project would normally only need <em>one</em> of these.</p>
<p>Some typical names: <code>localhost</code>, <code>127007</code>.</p>
<h3 id="intermediate-deployment-environments">Intermediate deployment environments</h3>
<p>Intermediate deployments are those that are not customer facing,
but are also not running on any developer’s machines.
Usually these are run on CI/ CD servers (or provisioned by them).
A project would normally have <em>several</em> of these.</p>
<p>Some typical names: <code>dev</code>, <code>staging</code>, <code>pentest</code>, <code>loadtest</code>.</p>
<h3 id="production-deployment-environment">Production deployment environment</h3>
<p>A production deployment is one that is customer facing,
so an actual customer of your business is going to hit this service,
meaning that any downtime could mean that your business loses money.
Therefore the acceptable downtime is zero -
or, <em>practically</em>, as close to zero as you can possibly manage.
A project would normally have <em>one</em> of these.</p>
<p>Some typical names: <code>live</code>, <code>production</code>.</p>
<h3 id="-node_env-"><code>NODE_ENV</code></h3>
<p>The categorisation above <em>does not</em> imply
the value of the <code>NODE_ENV</code> environment variable.
Though the similar name might make it seem so,
they are indeed <em>different concepts</em>.
The value of <code>NODE_ENV</code> determines the optimisation level under which
the <code>node</code> binary executes the code.
Additionally, many NodeJs libraries also do their own optimisations
based on the value of <code>NODE_ENV</code>.</p>
<p>Here are example profiles of an <code>express</code> server running
without <code>production</code>, then with <code>production</code>:</p>
<p><img src="https://dt-cdn.net/wp-content/uploads/2015/07/localhost_3000_burst1_html-600x288.png" alt="Flame graph of express with NODE_ENV set to anything else, and production"></p>
<p>Read the full article for a more in-depth explanation:
<a href="https://www.dynatrace.com/blog/the-drastic-effects-of-omitting-node_env-in-your-express-js-applications/">The drastic effects of omitting NODE_ENV in your Express.js applications</a>.</p>
<p>Therefore in the example above, we would want to have the
<code>live</code> deployment run with <code>NODE_ENV=production</code> (no surprises here).
Also, we might want the <code>pentest</code> and <code>loadtest</code> deployments
run with <code>NODE_ENV=production</code> as well,
because we want those performance optimisations in place,
even though they fall into the category of intermediate deployments.
Thus, we quickly see the value of keeping
the concepts of what <em>production</em> means separate:
When thinking about our deployment environments,
versus when thinking about what the value of <code>NODE_ENV</code> should be.</p>
<h2 id="task-runner">Task runner</h2>
<p>When you have a NodeJs project,
more often than not, you will have several tasks that you do often enough,
and the standard practice for these is to standardise them -
especially important in a collaborative development scenarios
such as open source, and in-house development teams.</p>
<p><code>npm</code>, the de facto package manager for NodeJs projects,
provides a handy way to do this via <code>npm run someTask</code>,
where <code>someTask</code> is specified within <code>package.json</code>,
in the <code>scripts</code> section.</p>
<p>This is quite handy for simple tasks -
where there are no environment variables involved,
and where the task is always the same no matter which deployment it is being run on.
However, when a project approaches a certain level of complexity,
some of its tasks will need to vary based on the deployment environment,
and they will need to make use of environment variables.
This is where <code>cross-env</code> and <code>better-npm-run</code> come in.
They are NodeJs libraries that are designed to augment <code>npm run</code>
allowing you to overcome those two initial hurdles.</p>
<h2 id="additional-hurdles">Additional hurdles</h2>
<p>As a project becomes even more complex,
you might encounter some extra hurdles
related to deployment in different environments.</p>
<h3 id="variable-substitution">Variable substitution</h3>
<ul>
<li>You might need to substitute the value of an environment variable into another one</li>
<li>You might need to substitute the value of an environment variable into the command</li>
</ul>
<h3 id="different-configuration-files">Different configuration files</h3>
<ul>
<li>You might need to load different sets of configuration files based on the deployment environment</li>
</ul>
<h3 id="different-tasks">Different tasks</h3>
<ul>
<li>You might need to run a completely different command for a particular task based on the environment<ul>
<li>For example <code>localhost</code> might need to run a server via <code>nodemon</code>, whereas the other environments might need to run the server via <code>node</code> directly</li>
</ul>
</li>
</ul>
<h3 id="sub-environments">Sub-environments</h3>
<ul>
<li>You might need to define environments hierarchically rather than as a flat list</li>
<li>You might have ad-hoc environments that are spun up, created dynamically by CI/ CD</li>
</ul>
<h2 id="introducing-erun-">Introducing <code>erun</code></h2>
<p>The name is a contraction of <em>environment runner</em>.</p>
<p><code>erun</code> is an implementation that implements all of the
requirements listed above -
and was created to scratch the proverbial itch,
after running into all of these scenarios.</p>
<p>Head over to the <a href="https://github.com/bguiz/erun">erun project page</a>
to check out sample usage.</p>
</span></div><div id="page-footer" class="page-footer"><div class="share-buttons__share-buttons___3c-nq"><ul class="share-buttons__share-items___35ozf"><li class="share-buttons__share-item___10u_7"><a href="mailto:?subject=Managing NodeJs Deployments in Multiple Environments - Brendan Graetz&amp;amp;body=http://blog.bguiz.com/2017/managing-multi-env-nodejs-deployments" class="share-buttons__share-button-email___3ktqW share-buttons__share-button___36_MO"><span class="fa fa-envelope"></span><div class="share-count"> </div></a></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--facebook share-buttons__share-button-facebook___uSKF_ share-buttons__share-button___36_MO"><span class="fa fa-facebook"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--twitter share-buttons__share-button-twitter___3vZWS share-buttons__share-button___36_MO"><span class="fa fa-twitter"></span><div class="share-count"> </div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--googlePlus share-buttons__share-button-google-plus___1OUuW share-buttons__share-button___36_MO"><span class="fa fa-google-plus"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--linkedin share-buttons__share-button-linkedin___2EwnF share-buttons__share-button___36_MO"><span class="fa fa-linkedin"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li></ul></div><div><span>Tagged in:</span><ul class="post-tags__tags-list___3m4XD"><li class="post-tags__tags-item___3xlEk"><a href="/tags/nodejs">nodejs</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/devops">devops</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/config">config</a></li></ul></div><div><a href="https://github.com/bguiz/blog.bguiz.com/blob/develop/src/documents/reactpubposts/2017-02-managing-multi-env-nodejs-deployments.md" target="_blank">Edit this content</a></div><div><div title="Managing NodeJs Deployments in Multiple Environments"><div id="disqus_thread"></div><noscript><span>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></span></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footprofile" class="foot-profile__footprofile___23hoj"><div class="foot-profile__footprofile-logo___3JA-e"><img src="/images/logo-100px.png" alt="Brendan Graetz"/></div><div class="foot-profile__footprofile-links___3U9KR"><ul class="foot-profile__footer-links___2SYBF"><li class="foot-profile__footer-item___22yBd"><a title="Brendan Graetz" href="/"><span class="fa fa-home foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Brendan Graetz</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Archives" href="/archives"><span class="fa fa-files-o foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Archives</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Presentations" href="/presentations"><span class="fa fa-television foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Presentations</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Books" href="/books"><span class="fa fa-book foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Books</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://twitter.com/bguiz" title="@bguiz on Twitter"><span class="fa fa-twitter foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">@bguiz</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://github.com/bguiz" title="bguiz on github"><span class="fa fa-github foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Github</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://stackoverflow.com/users/194982/bguiz" title="bguiz on stackoverflow"><span class="fa fa-stack-overflow foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Stackoverflow</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://linkedin.com/in/brendangraetz/" title="Brendan Graetz on LinkedIn"><span class="fa fa-linkedin foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">LinkedIn</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://reddit.com/u/bguiz" title="/u/bguiz on Reddit"><span class="fa fa-reddit-alien foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Reddit</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://plus.google.com/112370545733832378774?rel=author" title="@bguiz on Google+"><span class="fa fa-google-plus foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">+bguiz.com</span></a></li></ul></div><div class="foot-profile__clear___1vNYP"></div></div><div id="footbar" class="footbar__footbar___2dhrz"><p class="footbar__footbar-text___Rc4dT">Copyright © 2008-present Brendan Graetz</p></div></div>
    </div>
    
<link rel="stylesheet" type="text/css" href="/app.css">
<link rel="stylesheet" type="text/css" href="/3rd-party/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/3rd-party/highlight-js/css/dracula.css">
<script type="text/javascript" src="/bundle.js"></script>
  </body>
</html>