<!DOCTYPE html>
<html id="html" class="html">
  <head lang="en_GB">
  <meta charset="utf-8" />
  <title data-react-helmet="true">Creating 3rd-party Embeddable Widgets in HTML and JS - Brendan Graetz</title>
  <meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/><meta data-react-helmet="true" name="og:ttl" content="600"/><meta data-react-helmet="true" name="og:site_name" content="Brendan Graetz"/><meta data-react-helmet="true" name="og:description" content="The blog that Brendan writes"/><meta data-react-helmet="true" name="og:locale" content="en_GB"/><meta data-react-helmet="true" name="og:title" content="Creating 3rd-party Embeddable Widgets in HTML and JS - Brendan Graetz"/><meta data-react-helmet="true" name="og:url" content="http://blog.bguiz.com/articles/embeddable-widgets-html-javascript/"/><meta data-react-helmet="true" name="og:image" content="http://blog.bguiz.com/images/logo-400px.png"/><meta data-react-helmet="true" name="og:type" content="article"/>
  <link data-react-helmet="true" rel="canonical" content="http://blog.bguiz.com/articles/embeddable-widgets-html-javascript/"/>
</head>
  <body>
    <div id="outlet" class="outlet">
      <div id="root-page" class="root-page"><noscript></noscript><div id="navbar" class="navbar__navbar___3unxB"><ul id="navbar-list" class="navbar__navbar-list___33l7N"><li class="navbar__navbar-item___bZsgu"><a class="fa fa-home" title="Brendan Graetz" href="/"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-files-o" title="Archives" href="/archives"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-television" title="Presentations" href="/presentations"></a></li><li class="navbar__navbar-item___bZsgu"><a class="fa fa-book" title="Books" href="/books"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://twitter.com/bguiz" class="fa fa-twitter" title="@bguiz on Twitter"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://github.com/bguiz" class="fa fa-github" title="bguiz on github"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://stackoverflow.com/users/194982/bguiz" class="fa fa-stack-overflow" title="bguiz on stackoverflow"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://linkedin.com/in/brendangraetz/" class="fa fa-linkedin" title="Brendan Graetz on LinkedIn"></a></li><li class="navbar__navbar-item___bZsgu"><a href="http://reddit.com/u/bguiz" class="fa fa-reddit-alien" title="/u/bguiz on Reddit"></a></li><li class="navbar__navbar-item___bZsgu"><a href="https://plus.google.com/112370545733832378774?rel=author" class="fa fa-google-plus" title="@bguiz on Google+"></a></li></ul></div><div id="root-content" class="root-content"><div id="page-article" class="page page-article"><noscript></noscript><h1 id="page-title" class="article-page__page-title___1GRM3">Creating 3rd-party Embeddable Widgets in HTML and JS</h1><div id="page-body" class="page-body"><div class="article-page__article-date___otwe1"></div><span class="markdown__markdown-render___9BIqe"><p>All the social media sites have their own widgets,
from the simple Facebook like button to entire Twitter timelines.</p>
<p>If you have your own platform, how do you go about creating a widget for it?
A widget where you could provide a HTML/ Javascript snippet,
that you could tell third parties to insert into the markup for their own website?</p>
<p>Here is how to create your very own 3rd party embeddable widget!</p>
<h2 id="the-goal-in-mind">The Goal In Mind</h2>
<p>We want to end up with two HTTP servers,
one representing your platform,
and the other representing the 3rd party site,
which wishes to embed widgets from your platform on your server.</p>
<p>The point of most widgets is to allow the user to,
interact with your platform,
while staying on the 3rd party website.
For example, if you read a blog post, and it has got a Facebook like button on it,
the user expects that when they click the like button,
the “like” action is added to her timeline on Facebook,
while staying put on the blog post page,
and not have to go to the Facebook website.</p>
<p>In order to demonstrate this,
we will need to create an API on the server;
and test that the user is able to invoke this API
using an embedded widget while remaining on the 3rd party site page.</p>
<h2 id="node-up">Node Up</h2>
<pre class="hljs undefined lang-undefined">mkdir embeddable-widget-demo
<span class="hljs-built_in">cd</span> embeddable-widget-demo
npm init
<span class="hljs-comment">#initialise your version control here, e.g. git init</span>
npm install --save express ejs
mkdir -p views/{client,server}</pre><p>Now we create the entry point for NodeJs, in <code>index.js</code>.
Import the required dependencies,
then create two express instances,
with each of them listening on a different port number.
This is how we simulate the different servers:</p>
<ul>
<li><code>serverApp</code> represents your platform</li>
<li><code>clientApp</code> represents the 3rd party site which wants to embed your platform’s widgets</li>
</ul>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">var</span> os = <span class="hljs-built_in">require</span>( <span class="hljs-string">'os'</span> );
<span class="hljs-keyword">var</span> ejs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ejs'</span>);

<span class="hljs-keyword">var</span> serverPort = process.env.SERVER_PORT || <span class="hljs-number">54100</span>;
<span class="hljs-keyword">var</span> clientPort = process.env.CLIENT_PORT || <span class="hljs-number">54101</span>;

<span class="hljs-keyword">var</span> serverApp = express();
<span class="hljs-keyword">var</span> clientApp = express();

http.createServer(serverApp).listen(serverPort);
http.createServer(clientApp).listen(clientPort);</pre><p>One more thing is missing though.
When this goes beyond a demo,
and your platform gets published,
you will be hosting it on a domain name,
and provide usage documentation for it,
which among other things,
says what the URLs for the widgets are.</p>
<p>Since we do not have that yet,
we work it out at run time based on the IP address.</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-keyword">var</span> networkInterfaces = os.networkInterfaces( );

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getIpAddress</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(networkInterfaces);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; keys.length; ++x) {
        <span class="hljs-keyword">var</span> netIf = networkInterfaces[keys[x]];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; netIf.length; ++ y) {
            <span class="hljs-keyword">var</span> addr = netIf[y];
            <span class="hljs-keyword">if</span> (addr.family === <span class="hljs-string">'IPv4'</span> &amp;&amp; !addr.internal) {
                <span class="hljs-keyword">return</span> addr.address;
            }
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">'127.0.0.1'</span>;
}

<span class="hljs-keyword">var</span> serverHost = <span class="hljs-string">'//'</span>+getIpAddress()+<span class="hljs-string">':'</span>+serverPort;
<span class="hljs-keyword">var</span> platformScript = <span class="hljs-string">'/3rd/platform.js'</span>;</pre><p>We can now, at any time, run the server using the command <code>node index.js</code>.
Right now, our servers do not do very much at all,
all requests will yield a <code>HTTP 404</code> result.</p>
<h2 id="creating-the-widget">Creating the Widget</h2>
<h3 id="page-dom-method">Page DOM method</h3>
<h4 id="serve-the-main-page">Serve the main page</h4>
<p>We could serve this file using a static file server,
provided we knew the domain ahead of time.
Since this is a demo,
we work this out at run time.
So we need to use a templating engine to render it,
passing in the domain as a template variable.</p>
<pre class="hljs undefined lang-undefined">clientApp.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'html'</span>);
clientApp.engine(<span class="hljs-string">'html'</span>, ejs.renderFile);
clientApp.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    res.render(<span class="hljs-string">'client/index'</span>, {
        <span class="hljs-attr">serverHost</span>: serverHost,
        <span class="hljs-attr">platformScript</span>: platformScript,
    });
});</pre><p>Of course, we now have to create the main page to have something to render.</p>
<pre class="hljs undefined lang-undefined">// views/client/index.html
&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"debug"</span>&gt;
    serverHost: &lt;%= serverHost %&gt;
&lt;/div&gt;

&lt;p&gt;<span class="hljs-type">Praesent</span> blandit dolor. <span class="hljs-type">Sed</span> non quam. <span class="hljs-type">In</span> vel mi sit amet augue congue elementum. <span class="hljs-type">Morbi</span> <span class="hljs-keyword">in</span> ipsum sit amet pede facilisis laoreet. <span class="hljs-type">Donec</span> lacus nunc, viverra nec, blandit vel, egestas et, augue. <span class="hljs-type">Vestibulum</span> tincidunt malesuada tellus. <span class="hljs-type">Ut</span> ultrices ultrices enim. <span class="hljs-type">Curabitur</span> sit amet mauris. <span class="hljs-type">Morbi</span> <span class="hljs-keyword">in</span> dui quis est pulvinar ullamcorper. <span class="hljs-type">Nulla</span> facilisi. <span class="hljs-type">Integer</span> lacinia sollicitudin massa. <span class="hljs-type">Cras</span> metus. <span class="hljs-type">Sed</span> aliquet risus a tortor. &lt;/p&gt;
&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"foo-widget"</span> <span class="hljs-class"><span class="hljs-keyword">data</span>-foo-id="1"&gt;&lt;/div&gt;</span>

&lt;p&gt;<span class="hljs-type">Integer</span> id quam. <span class="hljs-type">Morbi</span> mi. <span class="hljs-type">Quisque</span> nisl felis, venenatis tristique, dignissim <span class="hljs-keyword">in</span>, ultrices sit amet, augue. <span class="hljs-type">Proin</span> sodales libero eget ante. <span class="hljs-type">Nulla</span> quam. <span class="hljs-type">Aenean</span> laoreet. <span class="hljs-type">Vestibulum</span> nisi lectus, commodo ac, facilisis ac, ultricies eu, pede. <span class="hljs-type">Ut</span> orci risus, accumsan porttitor, cursus quis, aliquet eget, justo. <span class="hljs-type">Sed</span> pretium blandit orci. <span class="hljs-type">Ut</span> eu diam at pede suscipit sodales. <span class="hljs-type">Aenean</span> lectus elit, fermentum non, convallis id, sagittis at, neque. <span class="hljs-type">Nullam</span> mauris orci, aliquet et, iaculis et, viverra vitae, ligula. &lt;/p&gt;
&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"foo-widget"</span> <span class="hljs-class"><span class="hljs-keyword">data</span>-foo-id="2"&gt;&lt;/div&gt;</span>

&lt;script src=<span class="hljs-string">"&lt;%= serverHost %&gt;&lt;%= platformScript %&gt;"</span> async&gt;&lt;/script&gt;</pre><p>This is, of course, <strong>not</strong> a complete HTML page.
Please add all the additional markup required - <code>&lt;html&gt;</code>, <code>&lt;head&gt;</code>, <code>&lt;body&gt;</code>, et cetera.</p>
<h3 id="-iframe-method"><code>iframe</code> method</h3>
<p><code>//TODO</code></p>
<h2 id="responding-to-the-widget">Responding to the Widget</h2>
<h3 id="enable-cors">Enable CORS</h3>
<p>The first thing that we need to to do, if using the page DOM method,
is to enable cross origin resource sharing (CORS).</p>
<pre class="hljs undefined lang-undefined">serverApp.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'cors middleware'</span>);
    <span class="hljs-keyword">if</span> ((<span class="hljs-regexp">/^\/api\/3rd\/.+$/</span>).test(req.path)) {
        <span class="hljs-comment">//TODO if more security is required, perhaps ask each user to login to</span>
        <span class="hljs-comment">//an admin panel and white list the domains that they would like to embed these widgets on</span>
        <span class="hljs-comment">//Then test here that the domain matches</span>
        <span class="hljs-keyword">var</span> corsOrigin = req.headers.origin;
        <span class="hljs-keyword">var</span> corsMethod = req.headers[<span class="hljs-string">'access-control-request-method'</span>];
        <span class="hljs-keyword">var</span> corsHeaders = req.headers[<span class="hljs-string">'access-control-request-headers'</span>];
        <span class="hljs-keyword">var</span> hasACorsFlag = corsOrigin || corsMethod || corsHeaders;
        <span class="hljs-keyword">if</span> (hasACorsFlag) {
            res.header(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, corsOrigin);
            res.header(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, corsMethod);
            res.header(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, corsHeaders);
            res.header(<span class="hljs-string">'Access-Control-Max-Age'</span>, <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>);
            <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">'OPTIONS'</span>) {
                res.send(<span class="hljs-number">200</span>);
                <span class="hljs-keyword">return</span>;
            }
        }
    }
    next();
});</pre><p>Disclaimer:
This is not very secure, and you probably should <strong>not</strong> use it in production.
However, it is good enough for a demo!</p>
<h3 id="serve-the-platform-script-file">Serve the Platform Script File</h3>
<p>Once again, we could serve this file using a static file server,
provided we knew the domain ahead of time.
Since this is a demo,
we work this out at run time.
So we need to use a templating engine to render it,
passing in the domain as a template variable.</p>
<pre class="hljs undefined lang-undefined">serverApp.engine(<span class="hljs-string">'js'</span>, ejs.renderFile);
serverApp.get(platformScript, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    res.render(<span class="hljs-string">'server'</span>+platformScript, {
        <span class="hljs-attr">serverHost</span>: serverHost,
        <span class="hljs-attr">platformScript</span>: platformScript,
    });
});

<span class="hljs-comment">// views/server/3rd/platform.js</span>
<span class="hljs-meta">'use strict'</span>;
<span class="hljs-comment">/*globals document, console, XMLHttpRequest*/</span>

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'hello from server'</span>);

(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">global</span>) </span>{
    <span class="hljs-keyword">var</span> serverHost = <span class="hljs-string">'&lt;%= serverHost %&gt;'</span>;
    <span class="hljs-keyword">var</span> elements = <span class="hljs-built_in">document</span>.querySelectorAll(<span class="hljs-string">'.foo-widget'</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; elements.length; ++i) {
        <span class="hljs-keyword">var</span> el = elements[i];
        processElement(el);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processElement</span>(<span class="hljs-params">el</span>) </span>{
        <span class="hljs-keyword">var</span> id = el.getAttribute(<span class="hljs-string">'data-foo-id'</span>);
        <span class="hljs-keyword">var</span> processed = el.getAttribute(<span class="hljs-string">'data-foo-processed'</span>);
        <span class="hljs-keyword">if</span> (!id || processed === <span class="hljs-string">'done'</span>) {
            <span class="hljs-comment">//skip this one as it has either already been processed, or lacks an ID</span>
            <span class="hljs-comment">//This is done to ensure logic is not executed twice in the event that the</span>
            <span class="hljs-comment">//user erroneously embeds the script tag more than once on a single page</span>
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'skipping element:'</span>, el);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
        xhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            el.innerHTML = <span class="hljs-string">'foo-widget: '</span>+<span class="hljs-keyword">this</span>.responseText;
            el.setAttribute(<span class="hljs-string">'data-foo-processed'</span>, <span class="hljs-string">'done'</span>);
        };
        xhr.open(<span class="hljs-string">"GET"</span>, serverHost+<span class="hljs-string">'/api/3rd/foo-widget/init/'</span>+id);
        xhr.send();
    }
}());</pre><h3 id="respond-to-api-requests-from-widgets">Respond to API Requests from Widgets</h3>
<pre class="hljs undefined lang-undefined">serverApp.get(<span class="hljs-string">'/api/3rd/foo-widget/init/:id'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-keyword">var</span> id = req.params.id;
    res.send(<span class="hljs-string">'api response #'</span>+id);
});</pre><h2 id="testing-it-all-together">Testing it all together</h2>
<p>Run the servers that we just created:</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-selector-tag">node</span> <span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.js</span></pre><p>Fire up a browser, and open up the developer tools:
<code>Ctrl+Shift+C</code> in both Chrome and Firefox.
Switch to the network tab, so that you are ready to view captured AJAX requests.</p>
<p>Now go to <a href="http://0.0.0.0:54101/"><code>http://0.0.0.0:54101/</code></a>.</p>
<p>This should serve up <code>index.html</code> of the 3rd party site.</p>
<p>You should also see a AJAX request made to
<a href="http://0.0.0.0:54100/"><code>http://0.0.0.0:54100/</code></a>
for each widget that you have on the page in the network tab.</p>
<p>Replace <code>0.0.0.0</code> with your IP address, which can be obtained by running
<code>ifconfig</code> on *nix and <code>ipconfig</code> on Windows.</p>
<p>A snapshot of the work done so far:
<a href="https://github.com/bguiz/embeddable-widget-demo/tree/v0.0.1">bguiz/embeddable-widget-demo/tree/v0.0.1</a></p>
<h2 id="add-more-features">Add more features</h2>
<p>So far, we have the ability to embed a snippet of HTML served by the platform server
onto a page served by another (3rd party) server;
using minimal snippets.</p>
<p>That is not all that we need to do though -
we still need to add the ability for these widgets to interact with the
platform server.</p>
<p>We also would like to be able to add styles to the widgets.</p>
<p>Finally, let us make the platform server capable of serving up
widgets for multiple platforms (or namespaces).</p>
<h3 id="widgets-invoke-platform-apis">Widgets invoke platform APIs</h3>
<p>After <code>fooWidget.setAttribute(&#39;data-foo-processed&#39;, &#39;done&#39;);</code>,
add the following:</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">// views/server/3rd/foo/platform.js</span>
<span class="hljs-keyword">var</span> fooWidgetButton = fooWidget.querySelector(<span class="hljs-string">'.bar-button'</span>);
<span class="hljs-keyword">if</span> (!fooWidgetButton) {
    <span class="hljs-keyword">return</span>;
}
<span class="hljs-keyword">var</span> fooWidgetButtonFunction = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">/* ... */</span> };
<span class="hljs-keyword">if</span> (fooWidgetButton.addEventListener) {
    fooWidgetButton.addEventListener(<span class="hljs-string">'click'</span>, fooWidgetButtonFunction);
}
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fooWidgetButton.attachEvent) {
    fooWidgetButton.attachEvent(<span class="hljs-string">'onclick'</span>, fooWidgetButtonFunction);
}
<span class="hljs-keyword">else</span> {
    fooWidgetButton.onclick = fooWidgetButtonFunction;
}</pre><p>Turns out that when using raw Javascript,
without the aid a framework or a library like jQuery,
responding to a simple click event can be quite tricky to do properly!</p>
<p>The implementation of the click handler function would be:</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-keyword">var</span> fooWidgetButtonFunction = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">//TODO disable the button temporarily to prevent double-click</span>
    <span class="hljs-keyword">var</span> barXhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
    barXhr.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> result = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-keyword">this</span>.responseText);
        <span class="hljs-built_in">console</span>.log(result);
        <span class="hljs-keyword">var</span> barPara = fooWidget.querySelector(<span class="hljs-string">'.bar'</span>);
        <span class="hljs-keyword">if</span> (barPara) {
            barPara.innerHTML = <span class="hljs-built_in">JSON</span>.stringify(result);
        }
    };
    barXhr.open(<span class="hljs-string">'POST'</span>, serverHost+<span class="hljs-string">'/api/3rd/foo/widget/'</span>+id+<span class="hljs-string">'/bar?partyId='</span>+partyId);
    <span class="hljs-keyword">var</span> content = {
        <span class="hljs-attr">fooId</span>: id,
    };
    content = <span class="hljs-built_in">JSON</span>.stringify(content);
    barXhr.setRequestHeader(<span class="hljs-string">'Content-type'</span>, <span class="hljs-string">'application/json'</span>);
    barXhr.send(content);
};</pre><p>This sends off another <code>XMLHttpRequest</code>,
this time a <code>POST</code> with a post body.</p>
<p>We add the following API to accept this <code>POST</code> request.
At the moment, it is not much more than a glorified <code>echo</code> API -
sufficient for the pruposes of this demo though:</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">// index.js</span>
serverApp.post(<span class="hljs-string">'/api/3rd/:platform/widget/:id/:action'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-keyword">var</span> id = req.params.id;
    <span class="hljs-keyword">var</span> action = req.params.action;
    <span class="hljs-keyword">var</span> partyId = req.query.partyId;
    <span class="hljs-keyword">var</span> platformWidgetInitPath = platformWidgetInitPathTemplate.replace(<span class="hljs-string">':platform'</span>, req.params.platform);
    res.send({
        <span class="hljs-attr">action</span>: req.params.action,
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//In this demo, all actions succeed</span>
        content: req.body,
    });
});</pre><p>Add the following constant to the top of the file.</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">var</span> platformWidgetInitPathTemplate = <span class="hljs-string">'/3rd/:platform/widget-init.html'</span>;</pre><h3 id="adding-inline-css-styles-to-widgets">Adding inline CSS styles to widgets</h3>
<p>In the platform Javascript file,
we create a new function that will inject a <code>style</code> tag into the DOM
that contains the CSS that we require.</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">// server/3rd/genbook/platform.js</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">injectStyles</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> css = <span class="hljs-string">'&lt;%= inlineCss %&gt;'</span>;
    <span class="hljs-keyword">var</span> style = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'style'</span>);
    style.type = <span class="hljs-string">'text/css'</span>;
    <span class="hljs-keyword">if</span> (style.styleSheet) {
        style.styleSheet.cssText = css;
    }
    <span class="hljs-keyword">else</span> {
        style.appendChild(<span class="hljs-built_in">document</span>.createTextNode(css));
    }
    <span class="hljs-keyword">var</span> head = <span class="hljs-built_in">document</span>.head || <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'head'</span>);
    head.appendChild(style);
}</pre><p>Of course, it would be crazy to write the CSS right here,
in a Javascript string literal,
so we shall defer that to the templating engine and the platform server.</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">// index.js</span>
serverApp.get(platformScriptPathTemplate, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-keyword">var</span> partyId = req.query.partyId;
    <span class="hljs-keyword">var</span> platformScriptPath = platformScriptPathTemplate.replace(<span class="hljs-string">':platform'</span>, req.params.platform);
    <span class="hljs-keyword">var</span> platformStylePath = platformStylePathTemplate.replace(<span class="hljs-string">':platform'</span>, req.params.platform);
    <span class="hljs-comment">//TODO inserting the CSS file into the platform script like this is quite wasteful</span>
    <span class="hljs-comment">//This is a prime candidate for refactoring or at the very least result caching</span>
    fs.readFile(path.normalize(platformStylePath), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) </span>{
        data = ((!err &amp;&amp; data &amp;&amp; data.toString()) || <span class="hljs-string">''</span>).replace( <span class="hljs-regexp">/(?:\r\n|\r|\n)/g</span> , <span class="hljs-string">' '</span>);
        res.render(<span class="hljs-string">'server'</span>+platformScriptPath, {
            <span class="hljs-attr">partyId</span>: partyId,
            <span class="hljs-attr">serverHost</span>: serverHost,
            <span class="hljs-attr">platformScript</span>: platformScriptPath,
            <span class="hljs-attr">inlineCss</span>: data,
        });
    });
});</pre><p>Here, we modify the platform server route which serves the platform Javascript
to read the platform CSS file, strip it off new line chaarcters,
and then pass it to the templating engine.</p>
<p>This is a little hacky, and only fit for demonstration puposes.
Things to do would include:</p>
<ul>
<li>Minify the CSS</li>
<li>Escape other special characters</li>
<li>Cache the CSS response</li>
</ul>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">var</span> platformScriptPathTemplate = <span class="hljs-string">'/3rd/:platform/platform.js'</span>;
<span class="hljs-keyword">var</span> platformStylePathTemplate = __dirname+<span class="hljs-string">'/views/server/3rd/:platform/platform.css'</span>;</pre><p>These constants should also be added to the top of the file.</p>
<h3 id="refactor-to-serve-multiple-widget-platforms">Refactor to serve multiple widget platforms</h3>
<p>We have already done this in the previous steps!</p>
<p>By declaring the constants named <code>somethingTemplate</code>,
and then replacing the <code>:platform</code> part of it with the <code>:platform</code>
that we extract from the request path;
we can now create many platforms by simply adding
a new folder with the same name as the platform.</p>
<h2 id="testing-interactions-between-the-embedded-widgets-and-platform-server">Testing interactions between the embedded widgets and platform server</h2>
<p>A snapshot of the work so far:
<a href="https://github.com/bguiz/embeddable-widget-demo/tree/v0.0.2">bguiz/embeddable-widget-demo/tree/v0.0.2</a></p>
<p>… or see the complete set of changes since the first iteration:
<a href="https://github.com/bguiz/embeddable-widget-demo/compare/v0.0.1...v0.0.2">bguiz/embeddable-widget-demo/compare/v0.0.1…v0.0.2</a></p>
<p>Run <code>node index.js</code>, and click the buttons in each widget.
The widget should update to contain a JSON string,
which is the response from the server.</p>
<h2 id="adding-support-for-iframe-s">Adding support for <code>iframe</code>s</h2>
<p>Not all widgets need to be added using <code>iframe</code>s,
as manipulating the DOM on the page on which the widget was embeed is often sufficient.
However, when security is a big concern,
<code>iframe</code>s are slightly better,
as you no longer need to enable CORS.</p>
<p>Note however that it is not a silver bullet,
and that <a href="http://stackoverflow.com/a/25260056/194982">neither are very secure</a>.</p>
<h3 id="disable-cors">Disable CORS</h3>
<p>Firstly, determine whether we wish to use <code>iframe</code>s -
let us use them by default:</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">var</span> defaults = {
    <span class="hljs-attr">EMBED_TYPE</span>: <span class="hljs-string">'iframe'</span>,
    <span class="hljs-comment">//...</span>
};
<span class="hljs-comment">//NOTE Set EMBED_TYPE to "iframe" or "dom"</span>
<span class="hljs-keyword">var</span> useIframe = (process.env.EMBED_TYPE || defaults.EMBED_TYPE) === <span class="hljs-string">'iframe'</span>;</pre><p>In the same file, we enables CORS through our own middleware:</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">//enable CORS</span>
serverApp.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{ <span class="hljs-comment">/* ... */</span> });</pre><p>Change this, such that the middleware only gets added when <code>useIframe</code> is true.</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">//enable CORS - only if not using iframes</span>
<span class="hljs-keyword">if</span> (!useIframe) {
    serverApp.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{ <span class="hljs-comment">/* ... */</span> });
}</pre><p>We also pass the <code>useIframe</code> flag into the <code>render</code> statement
when serving the platform script:</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-title">res</span>.render('server'+platformScriptPath, {
    partyId: partyId,
    serverHost: serverHost,
    platformScript: platformScriptPath,
    inlineCss: <span class="hljs-class"><span class="hljs-keyword">data</span>,</span>
    useIframe: useIframe,
});</pre><h3 id="platform-script-inserts-iframe-instead">Platform script inserts <code>iframe</code> instead</h3>
<p>Capture the <code>useIframe</code> variable in a template:</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-comment">// views/server/3rd/foo/platform.js</span>
<span class="hljs-keyword">var</span> useIframe = &lt;%= useIframe %&gt;;</pre><p>In the <code>processFooWidget</code> function,
split the existing logic that deals with initialising the widget
into a new function, called <code>createFooWidget</code>.</p>
<p>In this function, use templating to create two different render paths,
depending on whether <code>useIframe</code> is true or false.</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createFooWidget</span>(<span class="hljs-params">fooWidget, id</span>) </span>{
    &lt;% <span class="hljs-keyword">if</span> (useIframe) { %&gt;
        <span class="hljs-comment">/* ... */</span>
    &lt;% } <span class="hljs-keyword">else</span> { %&gt;
        <span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> XMLHttpRequest();
        <span class="hljs-comment">/* (existing same-page DOM code) */</span>
    &lt;% } %&gt;
}</pre><p>In the render path for when <code>useIframe</code> is true,
we create the <code>iframe</code> as a DOM element,
and simply set its source to the widget HTML.</p>
<p>When we do, the URL that the widget HTML is slightly modified,
to include an extra query parameter, <code>iframe=true</code>.</p>
<pre class="hljs undefined lang-undefined"><span class="hljs-keyword">var</span> iframe = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'iframe'</span>);
iframe.setAttribute(<span class="hljs-string">'src'</span>, serverHost+<span class="hljs-string">'/api/3rd/foo/widget/'</span>+id+<span class="hljs-string">'/init?iframe=true&amp;partyId='</span>+partyId);
iframe.setAttribute(<span class="hljs-string">'class'</span>, <span class="hljs-string">'foo-widget-iframe'</span>);
iframe.setAttribute(<span class="hljs-string">'data-foo-id'</span>, id);
iframe.setAttribute(<span class="hljs-string">'width'</span>, <span class="hljs-string">'200px'</span>);
iframe.setAttribute(<span class="hljs-string">'frameborder'</span>, <span class="hljs-string">'0'</span>);
iframe.setAttribute(<span class="hljs-string">'scrolling'</span>, <span class="hljs-string">'no'</span>);
iframe.style.border = <span class="hljs-string">'none'</span>;
iframe.style.height = <span class="hljs-string">'200px'</span>;
iframe.style.width = <span class="hljs-string">'200px'</span>;
iframe.style.position = <span class="hljs-string">'relative'</span>;
iframe.style.overflow = <span class="hljs-string">'hidden'</span>;
fooWidget.appendChild(iframe);
fooWidget.setAttribute(<span class="hljs-string">'data-foo-processed'</span>, <span class="hljs-string">'done'</span>);</pre><h3 id="move-platform-logic-from-platform-to-widget-html">Move platform logic from platform to widget HTML</h3>
<p>In the widget HTML, when <code>useIframe</code> is true,
we now render a <code>script</code> tag.
The contents of this <code>script</code> tag will be almost identical to the code within
<code>xhr.onload</code>:</p>
<ul>
<li>Setting <code>data-foo-processed</code> has already been done by the platform script.</li>
<li>Instead of setting <code>innerHTML</code>, we do not do anything - the <code>iframe</code> takes care of that for us!</li>
<li>Instead of using <code>fooWidget</code>, we use the <code>iframe</code>‘s content itself, which is referred to as <code>document</code></li>
</ul>
<pre class="hljs undefined lang-undefined">// views/server/3rd/foo/widget-init.html
&lt;% <span class="hljs-keyword">if</span> (isIframe) { %&gt;
&lt;script&gt;
    var serverHost = <span class="hljs-string">'&lt;%= serverHost %&gt;'</span>;
    var id = <span class="hljs-string">'&lt;%= id %&gt;'</span>;
    var partyId = <span class="hljs-string">'&lt;%= partyId %&gt;'</span>;
    var fooWidget = fooWidget;
    var fooWidgetButton = fooWidget.querySelector(<span class="hljs-string">'.bar-button'</span>);
    /* (similar to the code within `xhr.onload`) */
&lt;/script&gt;
&lt;% } %&gt;</pre><p>The main intent here is to move this logic from the platform script,
which is run by the page that embeds the widget,
to this script within the widget HTML,
which is run by a page from your own platform server within an <code>iframe</code>.</p>
<p>We do this in order for the widget to invoke the platform APIs
without performing a cross-domain request.</p>
<h2 id="testing-the-iframe-widgets">Testing the <code>iframe</code> widgets</h2>
<p>A snapshot of the work so far:
<a href="https://github.com/bguiz/embeddable-widget-demo/tree/v0.0.3">bguiz/embeddable-widget-demo/tree/v0.0.3</a></p>
<p>… or see the complete set of changes since the second iteration:
<a href="https://github.com/bguiz/embeddable-widget-demo/compare/v0.0.2...v0.0.3">bguiz/embeddable-widget-demo/compare/v0.0.2…v0.0.3</a></p>
<ul>
<li>Run <code>node index.js</code>, and the widgets should load within an <code>iframe</code>.</li>
<li>Run <code>EMBED_TYPE=dom node index.js</code>, and the widgets should load within the page DOM</li>
</ul>
<p>Of course, check that the server interactions continue to work,
in both the <code>iframe</code> version and the same-page DOM version.</p>
<p>Note that in production, you most likely will not need to support both methods
simultaneously, as we do here.
If this is the case, then most of the conditional logic that we have here
can be discarded, using just one or the other,
thereby reducing the load on the server when rendering these.</p>
<h2 id="some-pointers">Some Pointers</h2>
<h3 id="do-not-forget-to-document-things-for-the-3rd-parties">Do not forget to document things for the 3rd parties</h3>
<p>Third parties want to be able to embed your widgets,
but they need to know exactly how to do so.</p>
<p>Where possible make changes to the design of your widget to minimise
the amount of effort required on behalf of the 3rd party.
In this demo widget that we have built here,
I have tried to cut it down to the bare minimum:
the 3rd party site needs to copy the script tag once per page,
and the each of the <code>div</code>s where they want them to appear.</p>
<h3 id="expect-and-prepare-for-3rd-parties-to-use-widgets-in-unexpected-ways">Expect, and prepare, for 3rd parties to use widgets in unexpected ways</h3>
<p>One common way this will manifest itself is if you have instructions to
copy the script tag once per page only.
Some 3rd party sites will, inevitably, copy the script tag multiple times per page,
perhaps once per widget, because they misunderstood the instructions.</p>
<p>Plan for robustness.
Try doing precisely this, and refresh your page,
and you should see the <code>skipping element</code> being output to screen.
Be sure to build in robustness like this into the scripts driving your widgets.</p>
<p>Think of other situations in which the embed instructions could potentially be misused,
and plan contingency plans for each of them -
usually these would involve either ignoring or filtering.</p>
<p>For example, one more situation, which we have also taken into account in this demo widget,
is that 3rd party sites often are CMSes.
While some do allow Javascript,
many CMSes do not, and only allow HTML.
For this reason,
the configuration for the script and widgets are stored entirely in HTML data attributes,
instead of a config Javascript literal.</p>
<h2 id="source-code">Source Code</h2>
<p>If you would like to see the end result,
to see how it all fits together,
or just to give it a try,
you can find the
<a href="http://blog.bguiz.com/articles/embeddable-widgets-html-javascript/">accompanying source code for this here</a>.</p>
<h2 id="work-in-progress">Work in progress</h2>
<ul>
<li>Page DOM vs. insert an <code>iframe</code>: <a href="http://stackoverflow.com/q/25236746/194982">Question on Stackoverflow</a><ul>
<li>Include examples for both direct DOM manipulation and <code>iframe</code> methods</li>
</ul>
</li>
<li>One AJAX request per widget API is horribly wasteful, especially when you expect many of them to be on the same page. Consider coalescing the requests into one.</li>
<li>The page and widget are pretty bare bones at the moment, make them look nicer by adding some styles</li>
<li>Raw XHR - perhaps load jQuery or use some other library instead?<ul>
<li>This will complicate the widget by needing to support loading dependencies without polluting the 3rd party site</li>
</ul>
</li>
</ul>
</span></div><div id="page-footer" class="page-footer"><div class="share-buttons__share-buttons___3c-nq"><ul class="share-buttons__share-items___35ozf"><li class="share-buttons__share-item___10u_7"><a href="mailto:?subject=Creating 3rd-party Embeddable Widgets in HTML and JS - Brendan Graetz&amp;amp;body=http://blog.bguiz.com/articles/embeddable-widgets-html-javascript" class="share-buttons__share-button-email___3ktqW share-buttons__share-button___36_MO"><span class="fa fa-envelope"></span><div class="share-count"> </div></a></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--facebook share-buttons__share-button-facebook___uSKF_ share-buttons__share-button___36_MO"><span class="fa fa-facebook"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--twitter share-buttons__share-button-twitter___3vZWS share-buttons__share-button___36_MO"><span class="fa fa-twitter"></span><div class="share-count"> </div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--googlePlus share-buttons__share-button-google-plus___1OUuW share-buttons__share-button___36_MO"><span class="fa fa-google-plus"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li><li class="share-buttons__share-item___10u_7"><div role="button" tabindex="0" class="SocialMediaShareButton SocialMediaShareButton--linkedin share-buttons__share-button-linkedin___2EwnF share-buttons__share-button___36_MO"><span class="fa fa-linkedin"></span><div class="SocialMediaShareCount share-count"><span class="share-count-inner">&nbsp;</span></div></div></li></ul></div><div><span>Tagged in:</span><ul class="post-tags__tags-list___3m4XD"><li class="post-tags__tags-item___3xlEk"><a href="/tags/javascript">javascript</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/html">html</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/embed">embed</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/widget">widget</a></li><li class="post-tags__tags-item___3xlEk"><a href="/tags/nodejs">nodejs</a></li></ul></div><div><a href="https://github.com/bguiz/blog.bguiz.com/blob/develop/src/documents/articles/embeddable-widgets-html-javascript.html.md" target="_blank">Edit this content</a></div><div><div title="Creating 3rd-party Embeddable Widgets in HTML and JS"><div id="disqus_thread"></div><noscript><span>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></span></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by<span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footprofile" class="foot-profile__footprofile___23hoj"><div class="foot-profile__footprofile-logo___3JA-e"><img src="/images/logo-100px.png" alt="Brendan Graetz"/></div><div class="foot-profile__footprofile-links___3U9KR"><ul class="foot-profile__footer-links___2SYBF"><li class="foot-profile__footer-item___22yBd"><a title="Brendan Graetz" href="/"><span class="fa fa-home foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Brendan Graetz</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Archives" href="/archives"><span class="fa fa-files-o foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Archives</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Presentations" href="/presentations"><span class="fa fa-television foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Presentations</span></a></li><li class="foot-profile__footer-item___22yBd"><a title="Books" href="/books"><span class="fa fa-book foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Books</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://twitter.com/bguiz" title="@bguiz on Twitter"><span class="fa fa-twitter foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">@bguiz</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://github.com/bguiz" title="bguiz on github"><span class="fa fa-github foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Github</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://stackoverflow.com/users/194982/bguiz" title="bguiz on stackoverflow"><span class="fa fa-stack-overflow foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Stackoverflow</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://linkedin.com/in/brendangraetz/" title="Brendan Graetz on LinkedIn"><span class="fa fa-linkedin foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">LinkedIn</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="http://reddit.com/u/bguiz" title="/u/bguiz on Reddit"><span class="fa fa-reddit-alien foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">Reddit</span></a></li><li class="foot-profile__footer-item___22yBd"><a href="https://plus.google.com/112370545733832378774?rel=author" title="@bguiz on Google+"><span class="fa fa-google-plus foot-profile__footer-link-icon___11CDs"></span><span class="foot-profile__footer-link-text___1slED">+bguiz.com</span></a></li></ul></div><div class="foot-profile__clear___1vNYP"></div></div><div id="footbar" class="footbar__footbar___2dhrz"><p class="footbar__footbar-text___Rc4dT">Copyright © 2008-present Brendan Graetz</p></div></div>
    </div>
    
<link rel="stylesheet" type="text/css" href="/app.css">
<link rel="stylesheet" type="text/css" href="/3rd-party/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="/3rd-party/highlight-js/css/dracula.css">
<script type="text/javascript" src="/bundle.js"></script>
  </body>
</html>